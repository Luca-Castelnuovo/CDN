!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.FilePondPluginImageTransform=e()}(this,function(){"use strict";var w=function(t,e){return{x:t,y:e}},o=function(t,e){return w(t.x-e.x,t.y-e.y)},y=function(t,e){return Math.sqrt((i=o(n=t,r=e),a=o(n,r),i.x*a.x+i.y*a.y));var n,r,i,a},T=function(t,e){var n=t,r=e,i=1.5707963267948966-e,a=Math.sin(1.5707963267948966),o=Math.sin(r),u=Math.sin(i),h=Math.cos(i),l=n/a;return w(h*(l*o),h*(l*u))},P=function(t,e){var n,r,i,a,o,u,h,l,c,f=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,g=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{x:.5,y:.5},s=.5<g.x?1-g.x:g.x,d=.5<g.y?1-g.y:g.y,m=2*s*t.width,v=2*d*t.height,p=(r=f,i=(n=e).width,a=n.height,o=T(i,r),u=T(a,r),h=w(n.x+Math.abs(o.x),n.y-Math.abs(o.y)),l=w(n.x+n.width+Math.abs(u.y),n.y+Math.abs(u.x)),c=w(n.x-Math.abs(u.y),n.y+n.height-Math.abs(u.x)),{width:y(h,l),height:y(h,c)});return Math.max(p.width/m,p.height/v)},G=function(t,e){var n=t.width,r=n*e;return r>t.height&&(n=(r=t.height)/e),{x:.5*(t.width-n),y:.5*(t.height-r),width:n,height:r}},g={1:function(){return[1,0,0,1,0,0]},2:function(t){return[-1,0,0,1,t,0]},3:function(t,e){return[-1,0,0,-1,t,e]},4:function(t,e){return[1,0,0,-1,0,e]},5:function(){return[0,1,1,0,0,0]},6:function(t,e){return[0,1,-1,0,e,0]},7:function(t,e){return[0,-1,-1,0,e,t]},8:function(t){return[0,-1,1,0,0,t]}},s=function(t){return t&&(t.horizontal||t.vertical)},m=function(t,e,n){if(!e&&!s(n))return t.width=t.naturalWidth,t.height=t.naturalHeight,t;var r=document.createElement("canvas"),i=t.naturalWidth,a=t.naturalHeight,o=5<=e&&e<=8;r.height=o?(r.width=a,i):(r.width=i,a);var u,h,l,c=r.getContext("2d");if(e&&c.transform.apply(c,function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}((u=i,h=a,-1===(l=e)&&(l=1),g[l](u,h)))),s(n)){var f=[1,0,0,1,0,0];(!o&&n.horizontal||o&n.vertical)&&(f[0]=-1,f[4]=i),(!o&&n.vertical||o&&n.horizontal)&&(f[3]=-1,f[5]=a),c.transform.apply(c,f)}return c.drawImage(t,0,0,i,a),r},d=function(t,e,n){n||(n={});var r=m(t,e,n.flip),i={width:r.width,height:r.height},a=document.createElement("canvas"),o=n.aspectRatio||i.height/i.width,u=function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,r=t.height/t.width,i=e,a=1,o=r;i<o&&(a=(o=i)/r);var u=Math.max(1/a,i/o),h=t.width/(n*a*u),l=h*e;return{width:Math.round(h),height:Math.round(l)}}(i,o,n.zoom);a.width=u.width,a.height=u.height;var h={x:.5*a.width,y:.5*a.height},l=h.x-i.width*(n.center?n.center.x:.5),c=h.y-i.height*(n.center?n.center.y:.5),f={x:0,y:0,width:a.width,height:a.height,center:h},g=P(i,G(f,o),n.rotation,n.center),s=(n.zoom||1)*g,d=a.getContext("2d");return d.translate(h.x,h.y),d.rotate(n.rotation||0),d.scale(s,s),d.drawImage(r,l-h.x,c-h.y,i.width,i.height),d.getImageData(0,0,a.width,a.height)},v=function(){var i={resize:function(t,e){var n=e.mode,r=e.upscale,i=e.size,a=i.width,o=i.height;null===a?a=o:null===o&&(o=a);if("force"!==n){var u=a/t.width,h=o/t.height,l=1;if("cover"===n?l=Math.max(u,h):"contain"===n&&(l=Math.min(u,h)),1<l&&!1===r)return t;a=t.width*l,o=t.height*l}for(var c=t.width,f=t.height,g=Math.round(a),s=Math.round(o),d=t.data,m=new Uint8ClampedArray(g*s*4),v=c/g,p=f/s,w=Math.ceil(v/2),y=Math.ceil(p/2),T=0;T<s;T++)for(var A=0;A<g;A++){for(var M=4*(A+T*g),_=0,x=0,E=0,I=gx_g=gx_b=gx_a=0,R=(T+.5)*p,O=Math.floor(T*p);O<(T+1)*p;O++)for(var b=Math.abs(R-(O+.5))/y,F=(A+.5)*v,N=b*b,U=Math.floor(A*v);U<(A+1)*v;U++){var P=Math.abs(F-(U+.5))/w,G=Math.sqrt(N+P*P);-1<=G&&G<=1&&0<(_=2*G*G*G-3*G*G+1)&&(P=4*(U+O*c),gx_a+=_*d[P+3],E+=_,d[P+3]<255&&(_=_*d[P+3]/250),I+=_*d[P],gx_g+=_*d[P+1],gx_b+=_*d[P+2],x+=_)}m[M]=I/x,m[M+1]=gx_g/x,m[M+2]=gx_b/x,m[M+3]=gx_a/E}return{data:m,width:g,height:s}}},t=function(t,e){var n,r;e((n=t.transforms,r=t.imageData,n.forEach(function(t){var e=i[t.type];e&&(r=e(r,t.data))}),r))};self.onmessage=function(e){t(e.data.message,function(t){self.postMessage({id:e.data.id,message:t},[t.data.buffer])})}},u=function(t,e,n){if(1165519206===t.getUint32(e+4,!1)){e+=4;var r=18761===t.getUint16(e+=6,!1);e+=t.getUint32(e+4,r);var i=t.getUint16(e,r);e+=2;for(var a=0;a<i;a++)if(274===t.getUint16(e+12*a,r))return t.setUint16(e+12*a+8,1,r),!0;return!1}},p=function(r){return new Promise(function(t,e){var n=new FileReader;n.onload=function(){return t(function(t){var e=new DataView(t);if(65496!==e.getUint16(0))return null;for(var n=2,r=void 0,i=void 0,a=!1;n<e.byteLength&&(r=e.getUint16(n,!1),i=e.getUint16(n+2,!1)+2,65504<=r&&r<=65519||65534===r)&&(a||(a=u(e,n)),!(n+i>e.byteLength));)n+=i;return t.slice(0,n)}(n.result)||null)},n.readAsArrayBuffer(r.slice(0,262144))})},f=function(t){var r=t.loadImage,l=t.createWorker,h=t.getFilenameWithoutExtension,c=t.getFileFromBlob,f=function(o,e,u){return new Promise(function(a,t){var r,i,n=function(t){var e,n,r,i=c(t,(e=o.name,r=t.type,n="image/jpeg"===r||"image/png"===r?r:"image/jpeg",h(e)+"."+("image/jpeg"===n?"jpg":n.split("/")[1])));a(i)};(r=e,i=u,new Promise(function(t,e){var n=document.createElement("canvas");n.width=r.width,n.height=r.height,n.getContext("2d").putImageData(r,0,0),n.toBlob(t,i.type,i.quality)})).then(function(e){u.stripImageHead?n(e):p(o).then(function(t){null!==t&&(e=new Blob([t,e.slice(20)],{type:e.type})),n(e)})}).catch(function(t){console.error(t)})})};return function(a,o,u,h){return new Promise(function(i,t){var e=function(t){if(a.archived)return i(o);var e=(u.find(function(t){return"crop"===t.type})||{}).data,n=d(t,(a.getMetadata("exif")||{}).orientation||-1,e);if(!u.length)return f(o,n,h).then(i);var r=l(v);r.post({transforms:u,imageData:n},function(t){if(a.archived)return i(o);f(o,function(e){var n=void 0;try{n=new ImageData(e.width,e.height)}catch(t){n=document.createElement("canvas").getContext("2d").createImageData(e.width,e.height)}return n.data.set(e.data),n}(t),h).then(i),r.terminate()},[n.data.buffer])},n=URL.createObjectURL(o);r(n).then(function(t){URL.revokeObjectURL(n),e(t)})})}};HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(i,a,o){var u=this;setTimeout(function(){for(var t=u.toDataURL(a,o).split(",")[1],e=atob(t),n=e.length,r=new Uint8Array(n);n--;)r[n]=e.charCodeAt(n);i(new Blob([r],{type:a||"image/png"}))})}});var t=function(t){var e,N,U,n=t.addFilter,r=t.utils,i=r.Type,s=r.forin,a=r.loadImage,o=r.getFileFromBlob,u=r.getFilenameWithoutExtension,h=r.createWorker,l=r.createBlob,c=r.renameFile,d=r.isFile,m=["crop","resize"],v=f({loadImage:a,createWorker:h,getFileFromBlob:o,getFilenameWithoutExtension:u}),p=(N=(e={createBlob:l,renameFile:c}).createBlob,U=e.renameFile,function(b,F,e){return new Promise(function(I,t){var R=(e.find(function(t){return"crop"===t.type})||{}).data;if(!R)return I(F);var O=new FileReader;O.onloadend=function(){if(b.archived)return I(F);var t=O.result,e=document.createElement("div");e.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",e.innerHTML=t;var n=e.querySelector("svg");document.body.appendChild(e);var r=n.getBBox();e.parentNode.removeChild(e);var i=e.querySelector("title"),a=n.getAttribute("viewBox")||"",o=n.getAttribute("width")||"",u=n.getAttribute("height")||"",h=parseFloat(o)||null,l=parseFloat(u)||null,c=(o.match(/[a-z]+/)||[])[0]||"",f=(u.match(/[a-z]+/)||[])[0]||"",g=a.split(" ").map(parseFloat),s=g.length?{x:g[0],y:g[1],width:g[2],height:g[3]}:r,d=null!=h?h:s.width,m=null!=l?l:s.height;n.style.overflow="visible",n.setAttribute("width",d),n.setAttribute("height",m);var v=R.aspectRatio||m/d,p=d,w=p*v,y=P({width:d,height:m},G({width:p,height:w},v),R.rotation,R.center),T=R.zoom*y,A=.5*p,M=.5*w,_=["rotate("+R.rotation*(180/Math.PI)+" "+A+" "+M+")","translate("+A+" "+M+")","scale("+T+")","translate("+-A+" "+-M+")","translate("+(A-d*R.center.x)+" "+(M-m*R.center.y)+")"],x=["scale("+(R.flip.horizontal?-1:1)+" "+(R.flip.vertical?-1:1)+")","translate("+(R.flip.horizontal?-d:0)+" "+(R.flip.vertical?-m:0)+")"],E='<?xml version="1.0" encoding="UTF-8"?>\n<svg width="'+p+c+'" height="'+w+f+'" \nviewBox="0 0 '+p+" "+w+'" \npreserveAspectRatio="xMinYMin"\nxmlns="http://www.w3.org/2000/svg">\n\x3c!-- Generator: FilePond Image Transform Plugin - https://pqina.nl/filepond --\x3e\n<title>'+(i?i.textContent:F.name)+'</title>\n<desc>Cropped with FilePond.</desc>\n<g transform="'+_.join(" ")+'">\n<g transform="'+x.join(" ")+'">\n'+n.outerHTML+"\n</g>\n</g>\n</svg>";I(U(N(E,"image/svg+xml"),F.name))},O.readAsText(F)})});return n("SHOULD_PREPARE_OUTPUT",function(t,e){var n=e.query;return new Promise(function(t){t(!n("IS_ASYNC"))})}),n("PREPARE_OUTPUT",function(c,t){var f=t.query,g=t.item;return new Promise(function(e){if(!d(c)||!/^image/.test(c.type)||!f("GET_ALLOW_IMAGE_TRANSFORM")||g.archived)return e(c);var n=[];f("GET_IMAGE_TRANSFORM_VARIANTS_INCLUDE_ORIGINAL")&&n.push(function(){return new Promise(function(t){t({name:f("GET_IMAGE_TRANSFORM_VARIANTS_ORIGINAL_NAME"),file:c})})}),f("GET_IMAGE_TRANSFORM_VARIANTS_INCLUDE_DEFAULT")&&n.push(function(t,n,r){return new Promise(function(e){t(n,r).then(function(t){return e({name:f("GET_IMAGE_TRANSFORM_VARIANTS_DEFAULT_NAME"),file:t})})})});var t=f("GET_IMAGE_TRANSFORM_VARIANTS")||{};s(t,function(i,t){var r,a=(r=t,function(t,e,n){return t(e,r?r(n):n)});n.push(function(t,n,r){return new Promise(function(e){a(t,n,r).then(function(t){return e({name:i,file:t})})})})});var r=f("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),h=f("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY_MODE"),i=null===r?null:r/100,a=f("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),l=f("GET_IMAGE_TRANSFORM_CLIENT_TRANSFORMS")||m;g.setMetadata("output",{quality:i,type:a,client:l},!0);var o=function(o,u){return new Promise(function(t,e){var n=[];s(u,function(t,e){l.includes(t)&&n.push({type:t,data:e})}),n.sort(function(t,e){var n=m.indexOf(t.type),r=m.indexOf(e.type);return n<r?-1:r<n?1:0});var r=u.output||{},i=r.type,a=r.quality;return 0!==n.length||null!==a&&(null===a||"optional"!==h)||null!==i&&i!==o.type?/svg/.test(o.type)&&null===i?p(g,o,n).then(t):void v(g,o,n,{type:i||o.type,quality:a,stripImageHead:f("GET_IMAGE_TRANSFORM_OUTPUT_STRIP_IMAGE_HEAD")}).then(t):t(o)})},u=n.map(function(t){return t(o,c,g.getMetadata())});Promise.all(u).then(function(t){e(1===t.length&&null===t[0].name?t[0].file:t)})})}),{options:{allowImageTransform:[!0,i.BOOLEAN],imageTransformOutputMimeType:[null,i.STRING],imageTransformOutputQuality:[null,i.INT],imageTransformOutputStripImageHead:[!0,i.BOOLEAN],imageTransformClientTransforms:[null,i.ARRAY],imageTransformOutputQualityMode:["always",i.STRING],imageTransformVariants:[null,i.OBJECT],imageTransformVariantsIncludeDefault:[!0,i.BOOLEAN],imageTransformVariantsDefaultName:[null,i.STRING],imageTransformVariantsIncludeOriginal:[!1,i.BOOLEAN],imageTransformVariantsOriginalName:["original_",i.STRING]}}};return"undefined"!=typeof window&&void 0!==window.document&&document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:t})),t});
